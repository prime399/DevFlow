<UserControl x:Class="DevFlow.Presentation.Controls.RestRequestView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:controls="using:DevFlow.Controls"
             xmlns:converters="using:DevFlow.Converters">
    
    <UserControl.Resources>
        <converters:HttpMethodToBrushConverter x:Key="HttpMethodToBrushConverter" />
        <converters:BoolToTabBackgroundConverter x:Key="BoolToTabBackgroundConverter" />
    </UserControl.Resources>
    
    <Grid RowDefinitions="Auto,Auto,Auto,*,Auto,Auto">
        <!-- Request Tabs Bar -->
        <Border Grid.Row="0"
                Background="{StaticResource SurfaceVariantBrush}"
                BorderBrush="{StaticResource RequestBarBorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="0">
            <Grid ColumnDefinitions="*,Auto">
                <ScrollViewer Grid.Column="0"
                              HorizontalScrollBarVisibility="Auto"
                              VerticalScrollBarVisibility="Disabled">
                    <StackPanel x:Name="RequestTabsPanel" Orientation="Horizontal">
                        <ItemsControl x:Name="RequestTabsControl">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Horizontal" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="{Binding IsActive, Converter={StaticResource BoolToTabBackgroundConverter}}"
                                            BorderBrush="{StaticResource RequestBarBorderBrush}"
                                            BorderThickness="0,0,1,0"
                                            Padding="0"
                                            MinWidth="120"
                                            MaxWidth="200"
                                            PointerPressed="RequestTab_PointerPressed">
                                        <Grid ColumnDefinitions="Auto,*,Auto" Height="36">
                                            <Border Grid.Column="0"
                                                    CornerRadius="3"
                                                    Padding="6,2"
                                                    Margin="8,0,4,0"
                                                    VerticalAlignment="Center">
                                                <TextBlock Text="{Binding HttpMethod}"
                                                           FontFamily="{StaticResource AppFontFamilyBold}"
                                                           FontSize="10"
                                                           Foreground="{Binding HttpMethod, Converter={StaticResource HttpMethodToBrushConverter}}" />
                                            </Border>
                                            
                                            <Button Grid.Column="1"
                                                    Background="Transparent"
                                                    BorderThickness="0"
                                                    Padding="4,2"
                                                    MinWidth="0"
                                                    MinHeight="0"
                                                    CornerRadius="3"
                                                    HorizontalAlignment="Left"
                                                    VerticalAlignment="Center"
                                                    Click="TabName_Click"
                                                    ToolTipService.ToolTip="Click to rename">
                                                <StackPanel Orientation="Horizontal" Spacing="3">
                                                    <TextBlock Text="{Binding Name}"
                                                               Foreground="{StaticResource TextPrimaryBrush}"
                                                               FontFamily="{StaticResource AppFontFamily}"
                                                               FontSize="12"
                                                               TextTrimming="CharacterEllipsis"
                                                               MaxWidth="100"
                                                               VerticalAlignment="Center" />
                                                    <TextBlock Text="*"
                                                               Foreground="{StaticResource AccentPrimaryBrush}"
                                                               FontFamily="{StaticResource AppFontFamilyBold}"
                                                               FontSize="12"
                                                               Visibility="{Binding IsDirty}"
                                                               VerticalAlignment="Center" />
                                                </StackPanel>
                                            </Button>
                                            
                                            <Button Grid.Column="2"
                                                    Style="{StaticResource IconButtonStyle}"
                                                    Padding="4"
                                                    Margin="0,0,4,0"
                                                    VerticalAlignment="Center"
                                                    Click="CloseTab_Click"
                                                    ToolTipService.ToolTip="Close tab">
                                                <FontIcon Glyph="&#xE8BB;" FontSize="10" Foreground="{StaticResource TextMutedBrush}" />
                                            </Button>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        
                        <Button Style="{StaticResource IconButtonStyle}"
                                Click="AddNewTab_Click"
                                Margin="4,0,8,0"
                                Padding="8"
                                VerticalAlignment="Center"
                                ToolTipService.ToolTip="New request (Ctrl+T)">
                            <FontIcon Glyph="{StaticResource IconGlyphAdd}" FontSize="12" Foreground="{StaticResource TextMutedBrush}" />
                        </Button>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Border>
        
        <!-- Request URL Bar -->
        <Border Grid.Row="1"
                Background="{StaticResource RequestBarBackgroundBrush}"
                BorderBrush="{StaticResource RequestBarBorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="8">
            <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                <!-- Method Selector -->
                <Border Grid.Column="0"
                        Background="{StaticResource MethodSelectorBgBrush}"
                        CornerRadius="6,0,0,6"
                        BorderBrush="{StaticResource RequestBarBorderBrush}"
                        BorderThickness="1,1,0,1"
                        Padding="4,0">
                    <ComboBox x:Name="MethodComboBox"
                              SelectionChanged="HttpMethod_SelectionChanged"
                              Style="{StaticResource MethodComboBoxStyle}">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding}"
                                           Foreground="{Binding Converter={StaticResource HttpMethodToBrushConverter}}"
                                           FontFamily="{StaticResource AppFontFamilyBold}"
                                           FontWeight="Bold"
                                           FontSize="14" />
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                </Border>

                <!-- URL Input -->
                <Border Grid.Column="1"
                        Background="{StaticResource InputBackgroundBrush}"
                        BorderBrush="{StaticResource RequestBarBorderBrush}"
                        BorderThickness="1"
                        CornerRadius="0">
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBox x:Name="UrlTextBox"
                                 Grid.Column="0"
                                 PlaceholderText="https://api.example.com/endpoint"
                                 Style="{StaticResource UrlTextBoxStyle}" />
                        <ProgressRing x:Name="SendingProgress"
                                      Grid.Column="1"
                                      Width="20"
                                      Height="20"
                                      Margin="8,0"
                                      IsActive="False" />
                    </Grid>
                </Border>

                <!-- Send Button -->
                <Button Grid.Column="2"
                        x:Name="SendButton"
                        Content="Send"
                        Click="Send_Click"
                        Style="{StaticResource SendButtonStyle}"
                        Margin="8,0,4,0" />

                <!-- Save Button -->
                <Button Grid.Column="3"
                        Style="{StaticResource SaveButtonStyle}"
                        Margin="4,0,0,0">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <FontIcon Glyph="{StaticResource IconGlyphSave}" FontSize="14" />
                        <TextBlock Text="Save" FontFamily="{StaticResource AppFontFamilyMedium}" />
                    </StackPanel>
                </Button>
            </Grid>
        </Border>

        <!-- Tab Navigation Bar -->
        <Border Grid.Row="2"
                Background="{StaticResource TabBarBackgroundBrush}"
                BorderBrush="{StaticResource RequestBarBorderBrush}"
                BorderThickness="0,0,0,1">
            <StackPanel Orientation="Horizontal">
                <Button x:Name="TabParameters"
                        Content="Parameters"
                        Tag="0"
                        Click="ContentTab_Click"
                        Style="{StaticResource RequestTabActiveStyle}" />
                <Button x:Name="TabBody"
                        Content="Body"
                        Tag="1"
                        Click="ContentTab_Click"
                        Style="{StaticResource RequestTabStyle}" />
                <Button x:Name="TabHeaders"
                        Content="Headers"
                        Tag="2"
                        Click="ContentTab_Click"
                        Style="{StaticResource RequestTabStyle}" />
                <Button x:Name="TabAuth"
                        Content="Authorization"
                        Tag="3"
                        Click="ContentTab_Click"
                        Style="{StaticResource RequestTabStyle}" />
            </StackPanel>
        </Border>

        <!-- Content Area -->
        <Grid Grid.Row="3" Background="{StaticResource TabBarBackgroundBrush}">
            <!-- Parameters Panel -->
            <controls:KeyValueEditorControl x:Name="ParametersEditor"
                                            Visibility="Visible"
                                            Title="Query Parameters"
                                            AddButtonLabel="Add Parameter"
                                            ItemType="Parameter" />

            <!-- Body Panel -->
            <Grid x:Name="BodyPanel" Visibility="Collapsed" RowDefinitions="Auto,*">
                <Border Grid.Row="0"
                        Background="{StaticResource RequestBarBackgroundBrush}"
                        BorderBrush="{StaticResource RequestBarBorderBrush}"
                        BorderThickness="0,0,0,1"
                        Padding="16,10">
                    <Grid ColumnDefinitions="Auto,Auto,*,Auto">
                        <TextBlock Text="Content Type"
                                   Foreground="{StaticResource TextSecondaryBrush}"
                                   FontFamily="{StaticResource AppFontFamilyMedium}"
                                   FontSize="13"
                                   VerticalAlignment="Center"
                                   Margin="0,0,12,0" />
                        
                        <ComboBox Grid.Column="1"
                                  x:Name="ContentTypeComboBox"
                                  MinWidth="180"
                                  Background="{StaticResource MethodSelectorBgBrush}"
                                  BorderThickness="1"
                                  BorderBrush="{StaticResource RequestBarBorderBrush}"
                                  Padding="12,8"
                                  Margin="0,0,16,0">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Name}"
                                               Foreground="{StaticResource TextPrimaryBrush}"
                                               FontFamily="{StaticResource MonospaceFontFamily}"
                                               FontSize="13" />
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                        
                        <StackPanel Grid.Column="3" Orientation="Horizontal" Spacing="4">
                            <Button Style="{StaticResource IconButtonStyle}"
                                    ToolTipService.ToolTip="Format JSON"
                                    Click="FormatJson_Click">
                                <FontIcon Glyph="{StaticResource IconGlyphEdit}" FontSize="14" Foreground="{StaticResource TextMutedBrush}" />
                            </Button>
                        </StackPanel>
                    </Grid>
                </Border>
                
                <controls:CodeEditorControl x:Name="BodyEditor"
                                            Grid.Row="1"
                                            PlaceholderText="Enter request body here..." />
            </Grid>

            <!-- Headers Panel -->
            <controls:KeyValueEditorControl x:Name="HeadersEditor"
                                            Visibility="Collapsed"
                                            Title="Header List"
                                            AddButtonLabel="Add Header"
                                            ItemType="Header" />

            <!-- Authorization Panel -->
            <controls:AuthorizationEditorControl x:Name="AuthEditor"
                                                 Visibility="Collapsed" />
        </Grid>

        <!-- Response Splitter -->
        <Border Grid.Row="4"
                x:Name="ResponseSplitter"
                Background="{StaticResource SurfaceVariantBrush}"
                BorderBrush="{StaticResource RequestBarBorderBrush}"
                BorderThickness="0,1,0,1"
                Height="8"
                PointerPressed="Splitter_PointerPressed"
                PointerMoved="Splitter_PointerMoved"
                PointerReleased="Splitter_PointerReleased">
            <Border Background="{StaticResource TextMutedBrush}"
                    Width="48"
                    Height="4"
                    CornerRadius="2"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    Opacity="0.6" />
        </Border>

        <!-- Response Section -->
        <Border Grid.Row="5"
                x:Name="ResponseSection"
                Background="{StaticResource RequestBarBackgroundBrush}"
                MinHeight="150"
                MaxHeight="600"
                Height="280">
            <controls:ResponseViewerControl x:Name="ResponseViewer"
                                            ClearRequested="ResponseViewer_ClearRequested"
                                            DownloadRequested="ResponseViewer_DownloadRequested" />
        </Border>
    </Grid>
</UserControl>
