<UserControl x:Class="DevFlow.Presentation.Controls.RealtimeView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:controls="using:DevFlow.Controls"
             xmlns:converters="using:DevFlow.Converters">
    
    <UserControl.Resources>
        <converters:BoolToTabBackgroundConverter x:Key="BoolToTabBackgroundConverter" />
    </UserControl.Resources>
    
    <Grid RowDefinitions="Auto,Auto,Auto,*,Auto,*">
        <!-- Realtime Tabs Bar -->
        <Border Grid.Row="0"
                Background="{StaticResource SurfaceVariantBrush}"
                BorderBrush="{StaticResource RequestBarBorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="0">
            <Grid ColumnDefinitions="*,Auto">
                <ScrollViewer Grid.Column="0"
                              HorizontalScrollBarVisibility="Auto"
                              VerticalScrollBarVisibility="Disabled">
                    <StackPanel Orientation="Horizontal">
                        <ItemsControl x:Name="RealtimeTabsControl">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Horizontal" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="{Binding IsActive, Converter={StaticResource BoolToTabBackgroundConverter}}"
                                            BorderBrush="{StaticResource RequestBarBorderBrush}"
                                            BorderThickness="0,0,1,0"
                                            MinWidth="120"
                                            MaxWidth="200"
                                            PointerPressed="RealtimeTab_PointerPressed">
                                        <Grid ColumnDefinitions="Auto,*,Auto" Height="36">
                                            <Border Grid.Column="0"
                                                    CornerRadius="3"
                                                    Padding="6,2"
                                                    Margin="8,0,4,0"
                                                    VerticalAlignment="Center">
                                                <TextBlock Text="{Binding ProtocolName}"
                                                           FontFamily="{StaticResource AppFontFamilyBold}"
                                                           FontSize="9"
                                                           Foreground="{StaticResource HttpPutBrush}" />
                                            </Border>
                                            
                                            <Button Grid.Column="1"
                                                    Background="Transparent"
                                                    BorderThickness="0"
                                                    Padding="4,2"
                                                    MinWidth="0"
                                                    MinHeight="0"
                                                    CornerRadius="3"
                                                    HorizontalAlignment="Left"
                                                    VerticalAlignment="Center"
                                                    Click="RealtimeTabName_Click"
                                                    ToolTipService.ToolTip="Click to rename">
                                                <TextBlock Text="{Binding Name}"
                                                           Foreground="{StaticResource TextPrimaryBrush}"
                                                           FontFamily="{StaticResource AppFontFamily}"
                                                           FontSize="12"
                                                           TextTrimming="CharacterEllipsis"
                                                           MaxWidth="80"
                                                           VerticalAlignment="Center" />
                                            </Button>
                                            
                                            <Button Grid.Column="2"
                                                    Style="{StaticResource IconButtonStyle}"
                                                    Padding="4"
                                                    Margin="0,0,4,0"
                                                    VerticalAlignment="Center"
                                                    Click="CloseRealtimeTab_Click"
                                                    ToolTipService.ToolTip="Close tab">
                                                <FontIcon Glyph="&#xE8BB;" FontSize="10" Foreground="{StaticResource TextMutedBrush}" />
                                            </Button>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        
                        <Button Style="{StaticResource IconButtonStyle}"
                                Click="AddRealtimeTab_Click"
                                Margin="4,0,8,0"
                                Padding="8"
                                VerticalAlignment="Center"
                                ToolTipService.ToolTip="New Realtime connection (Ctrl+T)">
                            <FontIcon Glyph="{StaticResource IconGlyphAdd}" FontSize="12" Foreground="{StaticResource TextMutedBrush}" />
                        </Button>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Border>

        <!-- Protocol Tabs Bar -->
        <Border Grid.Row="1"
                Background="{StaticResource TabBarBackgroundBrush}"
                BorderBrush="{StaticResource RequestBarBorderBrush}"
                BorderThickness="0,0,0,1">
            <StackPanel Orientation="Horizontal">
                <Button x:Name="ProtocolWebSocket"
                        Tag="WebSocket"
                        Click="Protocol_Click"
                        Style="{StaticResource RequestTabActiveStyle}">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <FontIcon Glyph="{StaticResource IconGlyphRealtime}" FontSize="12" />
                        <TextBlock Text="WebSocket" FontFamily="{StaticResource AppFontFamilyMedium}" />
                    </StackPanel>
                </Button>
                <Button x:Name="ProtocolSSE"
                        Tag="SSE"
                        Click="Protocol_Click"
                        Style="{StaticResource RequestTabStyle}">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <FontIcon Glyph="{StaticResource IconGlyphStreaming}" FontSize="12" />
                        <TextBlock Text="SSE" FontFamily="{StaticResource AppFontFamilyMedium}" />
                    </StackPanel>
                </Button>
                <Button x:Name="ProtocolSocketIO"
                        Tag="SocketIO"
                        Click="Protocol_Click"
                        Style="{StaticResource RequestTabStyle}">
                    <StackPanel Orientation="Horizontal" Spacing="6">
                        <FontIcon Glyph="{StaticResource IconGlyphSync}" FontSize="12" />
                        <TextBlock Text="Socket.IO" FontFamily="{StaticResource AppFontFamilyMedium}" />
                    </StackPanel>
                </Button>
            </StackPanel>
        </Border>

        <!-- URL Bar -->
        <Border Grid.Row="2"
                Background="{StaticResource RequestBarBackgroundBrush}"
                BorderBrush="{StaticResource RequestBarBorderBrush}"
                BorderThickness="0,0,0,1"
                Padding="8">
            <Grid ColumnDefinitions="*,Auto">
                <Border Grid.Column="0"
                        Background="{StaticResource InputBackgroundBrush}"
                        BorderBrush="{StaticResource RequestBarBorderBrush}"
                        BorderThickness="1"
                        CornerRadius="6">
                    <Grid ColumnDefinitions="*,Auto">
                        <TextBox x:Name="UrlTextBox"
                                 Grid.Column="0"
                                 PlaceholderText="wss://ws.postman-echo.com/raw"
                                 Style="{StaticResource UrlTextBoxStyle}" />
                        <ProgressRing x:Name="ConnectingProgress"
                                      Grid.Column="1"
                                      Width="20"
                                      Height="20"
                                      Margin="8,0"
                                      IsActive="False" />
                    </Grid>
                </Border>

                <Button Grid.Column="1"
                        x:Name="ConnectButton"
                        Click="Connect_Click"
                        Margin="8,0,0,0"
                        Style="{StaticResource ConnectButtonStyle}">
                    <TextBlock x:Name="ConnectButtonText" Text="Connect" FontFamily="{StaticResource AppFontFamilySemiBold}" />
                </Button>
            </Grid>
        </Border>

        <!-- Message Editor -->
        <Grid Grid.Row="3" RowDefinitions="Auto,*">
            <Border Grid.Row="0"
                    Background="{StaticResource RequestBarBackgroundBrush}"
                    BorderBrush="{StaticResource RequestBarBorderBrush}"
                    BorderThickness="0,0,0,1"
                    Padding="12,8">
                <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                    <TextBlock Grid.Column="0"
                               Text="Message"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               FontFamily="{StaticResource AppFontFamilyMedium}"
                               FontSize="12"
                               VerticalAlignment="Center" />
                    <ComboBox Grid.Column="1"
                              x:Name="MessageFormat"
                              SelectedIndex="0"
                              Margin="12,0"
                              MinWidth="80"
                              VerticalAlignment="Center">
                        <ComboBoxItem Content="JSON" />
                        <ComboBoxItem Content="Text" />
                    </ComboBox>
                    <Button Grid.Column="2"
                            x:Name="SendButton"
                            Click="Send_Click"
                            IsEnabled="False"
                            Margin="0,0,8,0"
                            Style="{StaticResource SendButtonStyle}">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <FontIcon Glyph="{StaticResource IconGlyphSend}" FontSize="12" />
                            <TextBlock Text="Send" FontFamily="{StaticResource AppFontFamilySemiBold}" />
                        </StackPanel>
                    </Button>
                    <Button Grid.Column="3"
                            Click="ClearInput_Click"
                            Style="{StaticResource SecondaryButtonStyle}">
                        <TextBlock Text="Clear Input" 
                                   Foreground="{StaticResource TextSecondaryBrush}"
                                   FontFamily="{StaticResource AppFontFamilyMedium}"
                                   FontSize="12" />
                    </Button>
                </Grid>
            </Border>
            
            <controls:CodeEditorControl x:Name="MessageEditor"
                                        Grid.Row="1"
                                        PlaceholderText="// Enter your message here..."
                                        MinHeightOverride="100" />
        </Grid>

        <!-- Splitter -->
        <Border Grid.Row="4"
                Background="{StaticResource RequestBarBorderBrush}"
                Height="4">
            <Border Background="{StaticResource TextMutedBrush}"
                    Width="40"
                    Height="2"
                    CornerRadius="1"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center" />
        </Border>

        <!-- Log Section -->
        <Grid Grid.Row="5" RowDefinitions="Auto,*">
            <Border Grid.Row="0"
                    Background="{StaticResource SurfaceVariantBrush}"
                    BorderBrush="{StaticResource RequestBarBorderBrush}"
                    BorderThickness="0,0,0,1"
                    Padding="12,8">
                <Grid ColumnDefinitions="Auto,*,Auto">
                    <TextBlock Grid.Column="0"
                               Text="Log"
                               Foreground="{StaticResource TextSecondaryBrush}"
                               FontFamily="{StaticResource AppFontFamilySemiBold}"
                               FontSize="13"
                               VerticalAlignment="Center" />
                    <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4">
                        <Button Style="{StaticResource IconButtonStyle}"
                                Click="CopyLogs_Click"
                                ToolTipService.ToolTip="Copy all logs">
                            <FontIcon Glyph="{StaticResource IconGlyphCopy}" FontSize="12" Foreground="{StaticResource TextMutedBrush}" />
                        </Button>
                        <Button Style="{StaticResource IconButtonStyle}"
                                Click="ClearLogs_Click"
                                ToolTipService.ToolTip="Clear logs">
                            <FontIcon Glyph="{StaticResource IconGlyphDelete}" FontSize="12" Foreground="{StaticResource TextMutedBrush}" />
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <ScrollViewer x:Name="LogScrollViewer" Grid.Row="1">
                <ItemsControl x:Name="LogList">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Background="{StaticResource RequestBarBackgroundBrush}"
                                    BorderBrush="{StaticResource RequestBarBorderBrush}"
                                    BorderThickness="0,0,0,1"
                                    Padding="12,10">
                                <Grid ColumnDefinitions="Auto,Auto,*">
                                    <FontIcon Grid.Column="0"
                                              Glyph="{Binding TypeIcon}"
                                              FontSize="12"
                                              Margin="0,0,10,0"
                                              VerticalAlignment="Center" />
                                    
                                    <TextBlock Grid.Column="1"
                                               Text="{Binding TimestampFormatted}"
                                               Foreground="{StaticResource TextMutedBrush}"
                                               FontFamily="{StaticResource MonospaceFontFamily}"
                                               FontSize="11"
                                               Margin="0,0,12,0"
                                               VerticalAlignment="Center" />
                                    
                                    <TextBlock Grid.Column="2"
                                               Text="{Binding Message}"
                                               Foreground="{StaticResource TextPrimaryBrush}"
                                               FontFamily="{StaticResource AppFontFamily}"
                                               FontSize="12"
                                               TextTrimming="CharacterEllipsis"
                                               VerticalAlignment="Center" />
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Grid>
    </Grid>
</UserControl>
