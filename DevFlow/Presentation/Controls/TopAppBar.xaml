<UserControl x:Class="DevFlow.Presentation.Controls.TopAppBar"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="using:DevFlow.Presentation.Controls">

    <Grid Height="52" 
          Background="{StaticResource SurfaceBrush}"
          BorderBrush="{StaticResource BorderBrush}"
          BorderThickness="0,0,0,1">
        <Grid.ColumnDefinitions>
            <!-- Search Section -->
            <ColumnDefinition Width="*" />
            <!-- Profile Section -->
            <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <!-- Search Bar -->
        <Grid Grid.Column="0" 
              Margin="16,8"
              MaxWidth="600"
              HorizontalAlignment="Left">
            <Grid Background="{StaticResource SurfaceVariantBrush}"
                  CornerRadius="8"
                  Padding="12,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                
                <FontIcon Grid.Column="0"
                          Glyph="{StaticResource IconGlyphSearch}"
                          FontSize="14"
                          Foreground="{StaticResource TextMutedBrush}"
                          VerticalAlignment="Center"
                          Margin="0,0,8,0" />
                
                <TextBox x:Name="SearchTextBox"
                         Grid.Column="1"
                         PlaceholderText="Search requests, collections..."
                         Background="Transparent"
                         BorderThickness="0"
                         FontFamily="{StaticResource AppFontFamily}"
                         FontSize="{StaticResource FontSizeBody}"
                         Foreground="{StaticResource TextPrimaryBrush}"
                         VerticalAlignment="Center"
                         MinWidth="280" />
            </Grid>
        </Grid>

        <!-- Profile Section -->
        <StackPanel Grid.Column="1" 
                    Orientation="Horizontal" 
                    Spacing="8"
                    Margin="16,8">
            
            <!-- Sign In Button (shown when not authenticated) -->
            <Button x:Name="SignInButton"
                    Visibility="Visible"
                    Click="SignInButton_Click"
                    Background="Transparent"
                    BorderThickness="1"
                    BorderBrush="{StaticResource BorderBrush}"
                    CornerRadius="8"
                    Padding="16,8">
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <!-- Google Icon -->
                    <Viewbox Width="16" Height="16">
                        <PathIcon Data="M12.545 10.239v3.821h5.445c-0.712 2.315-2.647 3.972-5.445 3.972-3.332 0-6.033-2.701-6.033-6.032s2.701-6.032 6.033-6.032c1.498 0 2.866 0.549 3.921 1.453l2.814-2.814C17.503 2.988 15.139 2 12.545 2 7.021 2 2.543 6.477 2.543 12s4.478 10 10.002 10c8.396 0 10.249-7.85 9.426-11.748l-9.426-0.013z"
                                  Foreground="{StaticResource TextSecondaryBrush}" />
                    </Viewbox>
                    <TextBlock Text="Sign in with Google"
                               FontFamily="{StaticResource AppFontFamilyMedium}"
                               FontSize="{StaticResource FontSizeSmall}"
                               Foreground="{StaticResource TextPrimaryBrush}"
                               VerticalAlignment="Center" />
                </StackPanel>
            </Button>

            <!-- Profile Button (shown when authenticated) -->
            <Button x:Name="ProfileButton"
                    Visibility="Collapsed"
                    Click="ProfileButton_Click"
                    Background="Transparent"
                    BorderThickness="0"
                    Padding="4">
                <StackPanel Orientation="Horizontal" Spacing="10">
                    <!-- User Avatar or Initials -->
                    <Grid Width="32" Height="32">
                        <!-- Initials fallback -->
                        <Ellipse Fill="{StaticResource AccentPrimaryBrush}" />
                        <TextBlock x:Name="InitialsText"
                                   Text="?"
                                   FontFamily="{StaticResource AppFontFamilySemiBold}"
                                   FontSize="{StaticResource FontSizeSmall}"
                                   Foreground="{StaticResource SurfaceBrush}"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center" />
                        
                        <!-- Avatar Image (if available) -->
                        <Ellipse x:Name="AvatarEllipse" Visibility="Collapsed">
                            <Ellipse.Fill>
                                <ImageBrush x:Name="AvatarImageBrush" Stretch="UniformToFill" />
                            </Ellipse.Fill>
                        </Ellipse>
                    </Grid>

                    <!-- User Name -->
                    <TextBlock x:Name="UserNameText"
                               Text="User"
                               FontFamily="{StaticResource AppFontFamilyMedium}"
                               FontSize="{StaticResource FontSizeSmall}"
                               Foreground="{StaticResource TextPrimaryBrush}"
                               VerticalAlignment="Center"
                               MaxWidth="150"
                               TextTrimming="CharacterEllipsis" />

                    <!-- Dropdown indicator -->
                    <FontIcon Glyph="&#xE70D;"
                              FontSize="10"
                              Foreground="{StaticResource TextMutedBrush}"
                              VerticalAlignment="Center" />
                </StackPanel>
                
                <Button.Flyout>
                    <MenuFlyout Placement="BottomEdgeAlignedRight">
                        <MenuFlyoutItem x:Name="ProfileMenuItem" 
                                        Text="Profile" 
                                        Click="ProfileMenuItem_Click">
                            <MenuFlyoutItem.Icon>
                                <FontIcon Glyph="{StaticResource IconGlyphAuth}" />
                            </MenuFlyoutItem.Icon>
                        </MenuFlyoutItem>
                        <MenuFlyoutSeparator />
                        <MenuFlyoutItem x:Name="SignOutMenuItem" 
                                        Text="Sign Out"
                                        Click="SignOutMenuItem_Click">
                            <MenuFlyoutItem.Icon>
                                <FontIcon Glyph="&#xF3B1;" />
                            </MenuFlyoutItem.Icon>
                        </MenuFlyoutItem>
                    </MenuFlyout>
                </Button.Flyout>
            </Button>
            
            <!-- Loading indicator -->
            <ProgressRing x:Name="LoadingRing"
                          IsActive="False"
                          Width="24"
                          Height="24"
                          Visibility="Collapsed" />
        </StackPanel>
    </Grid>
</UserControl>
